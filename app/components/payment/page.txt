import ClientOnly from "../ClientOnly";
import getCurrentUser from "../../actions/getCurrentUser";
import { useEffect } from 'react';
import { useRouter } from 'next/router';
import axios from 'axios';
import toast from 'react-hot-toast';

const PaymentPage = async () => {
  const currentUser = await getCurrentUser();
  const router = useRouter();

  useEffect(() => {
    const initiatePayment = async () => {
      // Récupérer les détails de la réservation de l'URL ou de l'état global
      const { totalPrice, startDate, endDate, listingId } = router.query;

      try {
        // Appel à l'API pour créer une commande de paiement PayPal
        const response = await axios.post('../../api/paypal', {
          totalPrice,
          startDate,
          endDate,
          listingId
        });

        // Rediriger l'utilisateur vers l'URL d'approbation PayPal
        window.location.href = response.data.approvalUrl;
      } catch (error) {
        console.error('Erreur lors de l\'initialisation du paiement : ', error);
        toast.error('Erreur lors de l\'initialisation du paiement');
        router.push('/'); // Rediriger l'utilisateur vers la page d'accueil en cas d'erreur
      }
    };

    initiatePayment();
  }, []);

  return (
    <ClientOnly>
      <div>
        <p>Redirection vers PayPal...</p>
      </div>
    </ClientOnly>
  );
};

export default PaymentPage;
